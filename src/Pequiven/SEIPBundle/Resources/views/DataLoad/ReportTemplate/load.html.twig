{% extends 'PequivenSEIPBundle:Template:Developer/Common/formLayoutShow.html.twig' %}

{% trans_default_domain 'PequivenSEIPBundle' %}

{% import 'PequivenSEIPBundle:Template:Developer/Macros/buttons.html.twig' as buttons %}
{% import 'PequivenSEIPBundle:Template:Developer/Macros/actions.html.twig' as actions %}

{% block before_body %}
    {{ contentHeader(
        ("pequiven_seip.report_template.load.notification"|trans ),
        ("pequiven_seip.report_template.load.production"|trans )
    ) }}
{% endblock %}

{% block body %}
    <fieldset class="fieldset">
        <legend class="legend">{{ 'pequiven_seip.report_template.report_template'|trans }}</legend>
        <div class="columns">
            <div class="new-row-mobile six-columns six-columns-tablet twelve-columns-mobile">
                <p class="inline-label">
                    <label class="label">{{ 'pequiven.ref'|trans({},'messages') }}</label>
                    {{ generateLink(report_template) }}
                </p>
            </div>
            <div class="new-row-tablet new-row-mobile six-columns twelve-columns-tablet">
                <p class="inline-label">
                    <label class="label">{{ 'pequiven_seip.period'|trans }}</label>
                    {{ report_template.period }}
                </p>
            </div>
            <div class="new-row new-row-tablet new-row-mobile six-columns twelve-columns-tablet">
                <p class="inline-label">
                    <label class="label">{{ 'pequiven_seip.name'|trans }}</label>
                    {{ report_template.name }}
                </p>
            </div>
            <div class="new-row-tablet new-row-mobile six-columns twelve-columns-tablet">
                <p class="inline-label">
                    <label class="label">{{ 'Company'|trans }}</label>
                    {{ report_template.company }}
                </p>
            </div>
            <div class="new-row-tablet new-row-mobile six-columns twelve-columns-tablet">
                <p class="inline-label">
                    <label class="label">{{ 'Location'|trans }}</label>
                    {{ report_template.location }}
                </p>
            </div>
            <div class="new-row-tablet new-row-mobile six-columns twelve-columns-tablet">
                <p class="inline-label">
                    <label class="label">{{ 'Region'|trans }}</label>
                    {{ report_template.region }}
                </p>
            </div>
        </div>
    </fieldset>
                    
    <form action="{{ path('pequiven_report_template_load',{id: report_template.id}) }}" method="POST">
        <input type="hidden" name="_method" value="PUT">
        {{ form_errors(form) }}
        
        <div class="with-padding">
             <p class="inline-label"><label class="label">{{ "pequiven_seip.date_of_notification"|trans }}</label>
                 <a href="{{ path("pequiven_report_template_load",{id:report_template.id, dateNotification: (dateNotification|date_modify("-1 day")|date('d/m/Y'))}) }}" ><i class="fa fa-chevron-left fa-2x"></i></a>&nbsp;
                 <input type="text" id="dateNotification" name="dateNotification" class="input" value="{{ dateNotification|date('d/m/Y') }}" />&nbsp;
                 <a href="{{ path("pequiven_report_template_load",{id:report_template.id, dateNotification: (dateNotification|date_modify("+1 day")|date('d/m/Y'))}) }}" class="navigate-date"><i class="fa fa-chevron-right fa-2x"></i></a>
             </p>
         </div>
         {% set day = dateNotification|date('d')|round %}
         {% set grossPlan = 'day' ~ day ~ 'GrossPlan' %}
         {% set grossReal = 'day' ~ day ~ 'GrossReal' %}

         {% set netPlan = 'day' ~ day ~ 'NetPlan' %}
         {% set netReal = 'day' ~ day ~ 'NetReal' %}

         {% set observation = 'day' ~ day ~ 'Observation' %}
         {% set dayN = 'day' ~ day %}
         {% set dayNPlan = 'day' ~ day ~ 'Plan' %}
         {% set dayNReal = 'day' ~ day ~ 'Real' %}

         {% set dayNDetails = 'day' ~ day ~ 'Details' %}
         
         {% for plantReport in form.plantReports %}

             <details class="details margin-bottom" open>
                 <summary><strong class="font-20">{{ "Plant"|trans }}&nbsp;-&nbsp;{{ plantReport.vars.data }}</strong></summary>
                 <dl class="accordion same-height">
                     {% for productReport in plantReport.productsReport %}
                         <dt><i class="fa fa-cog"></i>&nbsp;<strong>{{ "Product"|trans }}&nbsp;-&nbsp;{{ productReport.vars.data }}&nbsp;({{ productReport.vars.data.product.productionLine }})</strong></dt>
                         <dd>
                             <div class="with-padding">
                                 <div class="columns">
                                     <div class="twelve-columns twelve-columns-mobile">
                                         <h3 class="thin underline text-center">Producci√≥n e Inventario</h3>
                                     </div>
                                 </div>
                                 <div class="columns">
                                     <div class="five-columns twelve-columns-mobile">
                                         <table class="simple-table responsive-table responsive-table-on" id="sorting-example2">
                                             <thead>
                                                 <tr>
                                                     <th class="header text-center white-gradient" colspan="4">{{ "pequiven_seip.report_template.load.production"|trans }}&nbsp;{{ "pequiven_seip.gross"|trans }}</th>
                                                 </tr>
                                                 <tr>
                                                     <th scope="col" style="width: 7%" class="header">Plan</th>
                                                     <th scope="col" style="width: 7%" class=" header">Real</th>
                                                     <th scope="col" style="width: 7%" class=" header">%</th>
                                                     <th scope="col" width="15%" class=" header">PNR</th>
                                                 </tr>
                                             </thead>
                                             <tbody>
                                                 {% for productDetailDailyMonth in productReport.productDetailDailyMonths %}
                                                     <tr>
                                                         <th scope="row">
                                                             {{ attribute(productDetailDailyMonth.vars.data,grossPlan) }}
                                                         </th>
                                                         <td>
                                                             {{ form_widget(attribute(productDetailDailyMonth,grossReal)) }}
                                                             {{ form_errors(attribute(productDetailDailyMonth,grossReal)) }}
                                                         </td>
                                                         <td>{{ attribute(productDetailDailyMonth.vars.data,'getTotalPercentajeOf',[day,'Gross'])|myNumberFormat }}</td>
                                                         <td>
                                                             {% for unrealizedProduction in productReport.unrealizedProductions %}
                                                                 {{ form_widget(attribute(unrealizedProduction,dayN)) }}
                                                                 {% set idPnrForm = 'dialog-form-pnr-' ~ unrealizedProduction.vars.data.id %}
                                                                 {% set idPnrButtom = 'dialog-button-pnr-' ~ unrealizedProduction.vars.data.id %}
                                                                 
                                                                 &nbsp;<a href="#" id="{{ idPnrButtom }}"><i class="fa fa-cog fa-2x"></i></a>
                                                                 {{ form_errors(attribute(unrealizedProduction,dayN)) }}
                                                                 <div id="{{ idPnrForm }}" title="{{ 'pequiven_seip.cause_of_PNR'|trans }}">
                                                                    {% set dayDetails = attribute(unrealizedProduction,dayNDetails) %}
                                                                    <ul class="internalCauses unstyled-list" data-prototype="{% filter escape %}{% include 'PequivenSEIPBundle:DataLoad/ReportTemplate/load:cause_fail.html.twig' with {form: dayDetails.internalCauses.vars.prototype, type: constant('Pequiven\\SEIPBundle\\Model\\CEI\\Fail::TYPE_FAIL_INTERNAL')} %}{% endfilter %}" >
                                                                        {% for internalCause in dayDetails.internalCauses %}
                                                                            <li>{% include 'PequivenSEIPBundle:DataLoad/ReportTemplate/load:cause_fail.html.twig' with {form: internalCause, type: constant('Pequiven\\SEIPBundle\\Model\\CEI\\Fail::TYPE_FAIL_INTERNAL')} %}</li>
                                                                        {% endfor %}
                                                                    </ul>
                                                                    <br/>
                                                                    <ul class="externalCauses unstyled-list" data-prototype="{% filter escape %}{% include 'PequivenSEIPBundle:DataLoad/ReportTemplate/load:cause_fail.html.twig' with {form: dayDetails.externalCauses.vars.prototype, type: constant('Pequiven\\SEIPBundle\\Model\\CEI\\Fail::TYPE_FAIL_EXTERNAL') } %}{% endfilter %}">
                                                                        {% for externalCause in dayDetails.externalCauses %}
                                                                            <li>{% include 'PequivenSEIPBundle:DataLoad/ReportTemplate/load:cause_fail.html.twig' with {form: externalCause, type: constant('Pequiven\\SEIPBundle\\Model\\CEI\\Fail::TYPE_FAIL_EXTERNAL')} %}</li>
                                                                        {% endfor %}
                                                                    </ul>
                                                                    <br/>
                                                                    <ul class="internalCausesMp unstyled-list" data-prototype="{% filter escape %}{% include 'PequivenSEIPBundle:DataLoad/ReportTemplate/load:raw_material_required.html.twig' with {form: dayDetails.internalCausesMp.vars.prototype} %}{% endfilter %}" >
                                                                        {% for internalCauseMp in dayDetails.internalCausesMp %}
                                                                            <li>
                                                                                <li>{% include 'PequivenSEIPBundle:DataLoad/ReportTemplate/load:raw_material_required.html.twig' with {form: internalCauseMp} %}</li>
                                                                            </li>
                                                                        {% endfor %}
                                                                    </ul>
                                                                    <br/>
                                                                    <ul class="externalCausesMp unstyled-list" data-prototype="{% filter escape %}{% include 'PequivenSEIPBundle:DataLoad/ReportTemplate/load:raw_material_required.html.twig' with {form: dayDetails.externalCausesMp.vars.prototype} %}{% endfilter %}">
                                                                        {% for externalCauseMp in dayDetails.externalCausesMp %}
                                                                            <li>
                                                                                <li>{% include 'PequivenSEIPBundle:DataLoad/ReportTemplate/load:raw_material_required.html.twig' with {form: externalCauseMp} %}</li>
                                                                            </li>
                                                                        {% endfor %}
                                                                    </ul>
                                                                  </div>
                                                                 <script type="text/javascript">
                                                                     $(function(){
                                                                         var dialog = $( "#{{ idPnrForm }}" ).dialog({
                                                                            autoOpen: false,
                                                                            height: 600,
                                                                            width: 650,
                                                                            modal: true,
                                                                            buttons: {
                                                                              "{{ "pequiven_seip.save"|trans }}": function(){dialog.dialog( "close" );},
                                                                              "{{ "pequiven_seip.cancel"|trans }}": function() {
                                                                                dialog.dialog( "close" );
                                                                              }
                                                                            },
                                                                            close: function() {
                                                                              //form[ 0 ].reset();
                                                                              //allFields.removeClass( "ui-state-error" );
                                                                            }
                                                                          });
                                                                          
                                                                           $( "#{{ idPnrButtom }}" ).on( "click", function() {
                                                                              dialog.dialog( "open" );
                                                                           });
                                                                           
                                                                     });
                                                                 </script>
                                                             {% endfor %}
                                                         </td>
                                                     </tr>
                                                 {% else %}
                                                     <tr>
                                                        <td colspan="4" class="empty_row">
                                                            {{ "empty.not_budgeted_gross_production"|trans }}
                                                        </td>
                                                    </tr>
                                                 {% endfor %}
                                             </tbody>
                                         </table>
                                     </div>
                                     <div class="four-columns twelve-columns-mobile">
                                         <table class="simple-table responsive-table responsive-table-on" id="sorting-example2">
                                             <thead>
                                                 <tr>
                                                     <th class="header text-center silver-gradient" colspan="3">{{ "pequiven_seip.report_template.load.production"|trans }}&nbsp;{{ "pequiven_seip.net"|trans }}</th>
                                                 </tr>
                                                 <tr>
                                                     <th scope="col" style="width: 7%">Plan</th>
                                                     <th scope="col" style="width: 7%" class=" header">Real</th>
                                                     <th scope="col" style="width: 7%" class=" header">%</th>
                                                 </tr>
                                             </thead>
                                             <tbody>
                                                 {% for productDetailDailyMonth in productReport.productDetailDailyMonths %}
                                                     <tr>
                                                         <th scope="row">
                                                             {{ attribute(productDetailDailyMonth.vars.data,netPlan) }}
                                                         </th>
                                                         <td>
                                                             {{ form_widget(attribute(productDetailDailyMonth,netReal)) }}
                                                             {{ form_errors(attribute(productDetailDailyMonth,netReal)) }}
                                                         </td>
                                                         <td>{{ attribute(productDetailDailyMonth.vars.data,'getTotalPercentajeOf',[day,'Net'])|myNumberFormat }}</td>
                                                     </tr>
                                                 {% else %}
                                                     <tr>
                                                        <td colspan="3" class="empty_row">
                                                            {{ "empty.not_budgeted_net_production"|trans }}
                                                        </td>
                                                    </tr>
                                                 {% endfor %}
                                             </tbody>
                                         </table>
                                     </div>
                                     <div class="three-columns twelve-columns-mobile">
                                         <table class="simple-table responsive-table responsive-table-on" id="sorting-example2">
                                             <thead>
                                                 <tr>
                                                     <th class="header text-center grey-gradient" >{{ "pequiven_seip.inventory"|trans }}</th>
                                                 </tr>
                                                 <tr>
                                                     <th scope="col" style="width: 7%" class=" header">Real</th>
                                                 </tr>
                                             </thead>
                                             <tbody>
                                                 {% if productReport.productDetailDailyMonths|length > 0 %}
                                                     {% for inventory in productReport.inventorys %}
                                                         <tr>
                                                             <th scope="row">
                                                                 {{ form_widget(attribute(inventory,dayN)) }}
                                                                 {{ form_errors(attribute(inventory,dayN)) }}
                                                             </th>
                                                         </tr>
                                                     {% else %}
                                                         <tr>
                                                            <td class="empty_row">
                                                                {{ "empty.no_handles_inventory"|trans }}
                                                            </td>
                                                        </tr>
                                                     {% endfor %}
                                                 {% else %}
                                                     <tr>
                                                        <td class="empty_row">
                                                            {{ "empty.no_details_of_production"|trans }}
                                                        </td>
                                                    </tr>
                                                 {% endif %}
                                             </tbody>
                                         </table>
                                     </div>
                                 </div>
                                 <div class="columns">
                                     <div class="twelve-columns twelve-columns-mobile">
                                         <h3 class="thin underline text-center">Consumo y Observaciones</h3>
                                     </div>
                                 </div>
                                 <div class="columns">
                                     <div class="six-columns twelve-columns-mobile">
                                         <table class="simple-table responsive-table responsive-table-on" id="sorting-example2">
                                             <thead>
                                                 <tr>
                                                     <th class="header text-center silver-gradient" colspan="4">{{ "pequiven_seip.report_template.raw_material"|trans }}</th>
                                                 </tr>
                                                 <tr>
                                                     <th scope="col" style="width: 15%">{{ "Product"|trans }}</th>
                                                     <th scope="col" style="width: 7%">Plan</th>
                                                     <th scope="col" style="width: 7%" class=" header">Real</th>
                                                     <th scope="col" style="width: 7%" class=" header">%</th>
                                                 </tr>
                                             </thead>
                                             <tbody>
                                                 {% set renderedError = false %}
                                                 {% for rawMaterialConsumptionPlanning in productReport.rawMaterialConsumptionPlannings %}
                                                     {% for detailRawMaterialConsumption in rawMaterialConsumptionPlanning.detailRawMaterialConsumptions %}
                                                         <tr>
                                                             <th scope="row">
                                                                 {{ rawMaterialConsumptionPlanning.vars.data }}&nbsp;({{ rawMaterialConsumptionPlanning.vars.data.getTypeLabel|trans }})
                                                             </th>
                                                             <td>{{ attribute(detailRawMaterialConsumption.vars.data,dayNPlan) }}</td>
                                                             <td>
                                                                 {{ form_widget(attribute(detailRawMaterialConsumption,dayNReal)) }}
                                                                 {{ form_errors(attribute(detailRawMaterialConsumption,dayNReal)) }}
                                                             </td>
                                                             <td>{{ attribute(detailRawMaterialConsumption.vars.data,'getTotalPercentajeOf',[day])|myNumberFormat }}</td>
                                                         </tr>
                                                         {% else %}
                                                             {% if renderedError == false %}
                                                                 {% set renderedError = true %}
                                                                 <tr>
                                                                    <td colspan="4" class="empty_row">
                                                                        {{ "empty.no_details_of_production"|trans }}
                                                                    </td>
                                                                </tr>
                                                            {% endif %}
                                                     {% endfor %}
                                                 {% else %}
                                                     <tr>
                                                         <td colspan="4" class="empty_row">
                                                             {{ "empty.no_details_of_raw_material"|trans }}
                                                         </td>
                                                     </tr>
                                                 {% endfor %}
                                             </tbody>
                                         </table>
                                     </div>
                                     <div class="six-columns twelve-columns-mobile">
                                         {% for productDetailDailyMonth in productReport.productDetailDailyMonths %}
                                             {{ form_widget(attribute(productDetailDailyMonth,observation)) }}
                                             {{ form_errors(attribute(productDetailDailyMonth,observation)) }}
                                         {% endfor %}
                                     </div>
                                 </div>
                             </div>
                         </dd>
                     {% endfor  %}
                 </dl>
             </details>

         {% endfor %}

         {% include 'PequivenSEIPBundle:DataLoad:ReportTemplate/show/services.html.twig' %}
         <br /><br />

         {{ actions.update() }}
{#         <p class="button-height align-right">#}
             {#{{ buttons.generic(path('pequiven_report_template_update', { 'id': report_template.id }),('pequiven.edit'|trans({},'messages'))) }}
             &nbsp;
             {{ buttons.delete(path('pequiven_report_template_delete', { 'id': report_template.id })) }}#}
{#         </p>#}
        <div class="">
             {{ form_rest(form) }}
        </div>
    </form>
{% endblock %}

{% block javascript %}
    <script type="text/javascript">
        $(document).ready(function(){
            $('#dateNotification').datepicker({
                 changeMonth: true,
                 dateFormat: "dd/mm/yy"
            }).on("change",function(){
                var changeToDate = $(this).val();
                var url = Routing.generate("pequiven_report_template_load",{id: "{{ report_template.id }}" ,dateNotification:changeToDate });
                window.location.href = url;
            });
            
            
            
            //internalCauses
            
            var buildCollection = function ($collectionHolder,newLinkLi,$addXLink){
                 // add a delete link to all of the existing tag form li elements
                $collectionHolder.find('li').each(function() {
                    addTagFormDeleteLink($(this));
                });

                // add the "add a tag" anchor and li to the tags ul
                $collectionHolder.append(newLinkLi);
                

                // count the current form inputs we have (e.g. 2), use that as the new
                // index when inserting a new item (e.g. 2)
                $collectionHolder.data('index', $collectionHolder.find(':input').length);
                
                $addXLink.on('click', function(e) {
                    // prevent the link from creating a "#" on the URL
                    e.preventDefault();

                    // add a new tag form (see next code block)
                    addTagForm($collectionHolder, newLinkLi);
                });
                
            };
            
            function addTagForm($collectionHolder, newLinkLi) {
                // Get the data-prototype explained earlier
                var prototype = $collectionHolder.data('prototype');

                // get the new index
                var index = $collectionHolder.data('index');

                // Replace '__name__' in the prototype's HTML to
                // instead be a number based on how many items we have
                var newForm = prototype.replace(/__name__/g, index);

                // increase the index with one for the next item
                $collectionHolder.data('index', index + 1);

                // Display the form in the page in an li, before the "Add a tag" link li
                var $newFormLi = $('<li></li>').append(newForm);
                $newFormLi.find('select').select2();
                
                // add a delete link to the new form
                addTagFormDeleteLink($newFormLi);
                
                newLinkLi.before($newFormLi);
                
            }
            
            function addTagFormDeleteLink($tagFormLi) {
                var $removeFormA = $('<a href="#" class="float-right icon-trash icon-size2">{{ "pequiven_seip.buttons.delete_cause"|trans }}</a>');
                $tagFormLi.append($removeFormA);

                $removeFormA.on('click', function(e) {
                    // prevent the link from creating a "#" on the URL
                    e.preventDefault();

                    // remove the li for the tag form
                    $tagFormLi.remove();
                });
            }
            
            $.each($('ul.internalCauses'),function(key,value){
                var $addInternalCauseLink = $('<a href="#" class="add_internal_cause_link icon-list-add icon-size2 tracked">{{ 'pequiven_seip.buttons.add_internal_cause'|trans }}</a>');
                var $newLinkLi = $('<li></li>').append($addInternalCauseLink);
                buildCollection($(value),$newLinkLi,$addInternalCauseLink);
            });
            $.each($('ul.externalCauses'),function(key,value){
                var $addInternalCauseLink = $('<a href="#" class="add_external_cause_link icon-list-add icon-size2 tracked">{{ 'pequiven_seip.buttons.add_external_cause'|trans }}</a>');
                var $newLinkLi = $('<li></li>').append($addInternalCauseLink);
                buildCollection($(value),$newLinkLi,$addInternalCauseLink);
            });
            $.each($('ul.internalCausesMp'),function(key,value){
                var $addInternalCauseLink = $('<a href="#" class="add_internal_causes_mp_link icon-list-add icon-size2 tracked">{{ 'pequiven_seip.buttons.add_internal_cause_mp'|trans }}</a>');
                var $newLinkLi = $('<li></li>').append($addInternalCauseLink);
                buildCollection($(value),$newLinkLi,$addInternalCauseLink);
            });
            $.each($('ul.externalCausesMp'),function(key,value){
                var $addInternalCauseLink = $('<a href="#" class="add_internal_causes_mp_link icon-list-add icon-size2 tracked">{{ 'pequiven_seip.buttons.add_external_cause_mp'|trans }}</a>');
                var $newLinkLi = $('<li></li>').append($addInternalCauseLink);
                buildCollection($(value),$newLinkLi,$addInternalCauseLink);
            });
        });
    </script>
{% endblock %}