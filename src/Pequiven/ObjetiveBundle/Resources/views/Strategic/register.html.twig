{#{% extends 'TecnocreacionesVzlaGovernmentBundle:Template:Developer/layout.html.twig' %}#}
{% extends 'PequivenSEIPBundle:Template:Developer/Common/formLayout.html.twig' %}

{% trans_default_domain 'PequivenObjetiveBundle' %}

{% import 'PequivenSEIPBundle:Template:Developer/Macros/actions.html.twig' as actions %}

{% block javascripts_base %}
    {{ parent() }}
    <!-- JavaScript at the bottom for fast page loading -->
    <!-- Scripts -->
    <script src="{{ asset('bundles/tecnocreacionesvzlagovernment/template/developer/js/libs/jquery-1.8.2.min.js') }}"></script>
    <script src="{{ asset('bundles/tecnocreacionesvzlagovernment/template/developer/js/setup.js') }}"></script>
{% endblock javascripts_base %}
    
{% block body %}

    <hgroup id="main-title" class="thin breadcrumb">
        <h1>
            <a href="#">{{ 'pequiven_objetive.objetives'|trans }}</a>
            <span class="icon-forward"></span>
            <span class="thin">{{ 'pequiven_objetive.add'|trans }}</span>
            <span class="icon-forward"></span>
            <span class="thin">{{ 'pequiven_objetive.strategic'|trans }}</span>
        </h1>
    </hgroup>
    
    <form action="{{ path('pequiven_objetive_menu_add_strategic') }}" {{ form_enctype(form) }} method="POST">
        <fieldset class="fieldset fields-list">
            <legend class="legend">{{ 'pequiven_objetive.objetives'|trans }}</legend>

            <!-- Línea Estratégica -->
            <a name="lineStrategic"></a>
            <div id="lineStrategic" class="field-block button-height">
                {{ form_label(form.lineStrategic) }}
                {{ form_widget(form.lineStrategic) }}
                {{ form_errors(form.lineStrategic) }}
                <span class="info-spot">
                    <span class="icon-info-round"></span>
                    <span class="info-bubble">{{ 'form.lineStrategic_info'|trans }}</span>
                </span>
            </div>
                
            <!-- Descripción -->
            <div class="field-block button-height">
                {{ form_label(form.description) }}
                {{ form_widget(form.description,{'attr':{'class':'input' } }) }}
                {{ form_errors(form.description) }}
                <span class="info-spot">
                    <span class="icon-info-round"></span>
                    <span class="info-bubble">{{ 'form.description_info'|trans }}</span>
                </span>
            </div>
                
            <!-- Ref -->
            <div id="ref" class="field-block button-height">
                {{ form_label(form.ref) }}
                {{ form_widget(form.ref) }}
                {{ form_errors(form.ref) }}
                <span id="ref_info" class="info-spot">
                    <span class="icon-info-round"></span>
                    <span class="info-bubble">{{ 'form.ref_info'|trans }}</span>
                </span>
            </div>
                
            <!-- Meta del Objetivo -->
            <div class="field-block button-height">
                    {{ form_label(form.goal) }}
                    {{ form_widget(form.goal) }}
                    {{ form_errors(form.goal) }}
                    <span class="info-spot">
                        <span class="icon-info-round"></span>
                        <span class="info-bubble">{{ 'form.goal_info'|trans }}</span>
                    </span>
            </div>
                    
            <!-- Rango de Gestión -->
            <fieldset class="fieldset">
                <legend class="legend">{{ 'form.rankArrangement'|trans }}</legend>
                <!-- Rango Alto del Objetivo -->
                <div class="field-block button-height">
                        {{ form_label(form.rankTop) }}
                        {{ form_widget(form.rankTop) }}
                        {{ form_errors(form.rankTop) }}
                        <span class="info-spot">
                            <span class="icon-info-round"></span>
                            <span class="info-bubble">{{ 'form.rankTop_info'|trans }}</span>
                        </span>
                </div>
                <!-- Rango Medio Alto del Objetivo -->
                <div class="field-block button-height">
                        {{ form_label(form.rankMiddleTop) }}
                        {{ form_widget(form.rankMiddleTop) }}
                        {{ form_errors(form.rankMiddleTop) }}
                        <span class="info-spot">
                            <span class="icon-info-round"></span>
                            <span class="info-bubble">{{ 'form.rankMiddleTop_info'|trans }}</span>
                        </span>
                </div>
                <!-- Rango Medio Bajo del Objetivo -->
                <div class="field-block button-height">
                        {{ form_label(form.rankMiddleBottom) }}
                        {{ form_widget(form.rankMiddleBottom) }}
                        {{ form_errors(form.rankMiddleBottom) }}
                        <span class="info-spot">
                            <span class="icon-info-round"></span>
                            <span class="info-bubble">{{ 'form.rankMiddleBottom_info'|trans }}</span>
                        </span>
                </div>
                <!-- Rango Bajo del Objetivo -->
                <div class="field-block button-height">
                        {{ form_label(form.rankBottom) }}
                        {{ form_widget(form.rankBottom) }}
                        {{ form_errors(form.rankBottom) }}
                        <span class="info-spot">
                            <span class="icon-info-round"></span>
                            <span class="info-bubble">{{ 'form.rankBottom_info'|trans }}</span>
                        </span>
                </div>
            </fieldset>
                
            <!-- Tipo de Evaluación -->
            <fieldset class="fieldset">
                <legend class="legend">{{ 'form.typeEvaluation'|trans }}</legend>
                <!-- Por Objetivo -->
                <div class="field-block button-height">
                    {{ form_label(form.evalObjetive) }}
                    {{ form_widget(form.evalObjetive) }}
                    {{ form_errors(form.evalObjetive) }}
                    <span class="info-spot">
                        <span class="icon-info-round"></span>
                        <span class="info-bubble">{{ 'form.evalObjetive_info'|trans }}</span>
                    </span>
                </div>
                <!-- Por Indicador -->
                <div class="field-block button-height">
                    {{ form_label(form.evalIndicator) }}
                    {{ form_widget(form.evalIndicator) }}
                    {{ form_errors(form.evalIndicator) }}
                    <span class="info-spot">
                        <span class="icon-info-round"></span>
                        <span class="info-bubble">{{ 'form.evalIndicator_info'|trans }}</span>
                    </span>
                    <span id="button_add_indicator">
                        <button type="button" class="button red-gradient glossy" onclick="openFormIndicator()">{{ 'pequiven_objetive.registerIndicator'|trans }}</button>
                    </span>
                    <span id="choice_line_strategic">
                        {{ 'form.messages.pleaseChoiceALineStrategic'|trans }}
                    </span>
                </div>
            </fieldset>
                    
            <!-- Añadir Indicadores -->
            <fieldset id="indicators" class="fieldset">
                <legend class="legend">{{ 'form.addIndicators'|trans }}</legend>
                <!-- Añadir Indicadores -->
                <div class="field-block button-height">
                    {{ form_label(form.indicators) }}
                    {{ form_widget(form.indicators) }}
                    {{ form_errors(form.indicators) }}
                    <span class="info-spot">
                        <span class="icon-info-round"></span>
                        <span class="info-bubble">{{ 'form.indicators_info'|trans }}</span>
                    </span>
                </div>
            </fieldset>
            
            {{ actions.create() }}
            
            {#{ actions.create_modal(path('pequiven_objetive_menu_create'),'pequiven_seip.register',{'content':'hola'}) }#}
            
        </fieldset>
    {{ form_rest(form) }}
    </form>
    
    {% block javascript %}
        
    <script type="text/javascript">
        $(document).ready(function()
        {
            var buttonAddIndicator = $('#button_add_indicator'),//Botón de Añadir Indicador
                messageCheckIndicator = $('#choice_line_strategic'),//Mensaje en caso de que no se haya seleccionado una Línea Estratégica
                sectionIndicators = $('#indicators'),//Sección dónde esta el select de Indicadores
                selectLineStrategic = $("#pequiven_objetive_strategic_registration_lineStrategic"),//Select de Línea Estratégica
                selectComplejo = $("#pequiven_objetive_strategic_registration_complejo"),//Select de Complejo
                selectIndicators = $("#pequiven_objetive_strategic_registration_indicators"),//Select de Indicadores
                inputRef = $("#pequiven_objetive_strategic_registration_ref"),//Input de Ref
                inputGoal = $("#pequiven_objetive_strategic_registration_goal"),//Input de Meta
                checkIndicator = $("#pequiven_objetive_strategic_registration_evalIndicator")//Check de Evaluar por Indicador
                ;
            
            charge();
            
            function charge(){
                //Escondemos por defecto el boton de registrar indicadores y el mensaje en cao de no haber seleccionado alguna Línea Estratégica
                buttonAddIndicator.hide();
                messageCheckIndicator.hide();
               
                //Escondemos por defecto la sección de sumar indicadores al objetivo
                sectionIndicators.hide();
               
                //Inicializamos el select de Línea Estratégica
                chargeSelect2LineStrategic();
               
                //Inicializamos el select de Complejo
                selectComplejo.select2({
                   
                });
               
                //Inicializamos el select de Indicadores
                chargeSelectIndicatorFromLineStrategic();
               
                //Incializamos el formato numerico para el input de Meta
                inputGoal.number(true,3,',','.');
               
                //Incializamos el formato numerico para el input de Rango Alto
                $("#pequiven_objetive_strategic_registration_rankTop").number(true,3,',','.');
               
                //Incializamos el formato numerico para el input de Rango Medio Alto
                $("#pequiven_objetive_strategic_registration_rankMiddleTop").number(true,3,',','.');
               
                //Incializamos el formato numerico para el input de Rango Medio Bajo
                $("#pequiven_objetive_strategic_registration_rankMiddleBottom").number(true,3,',','.');
               
               //Incializamos el formato numerico para el input de Rango Bajo
               $("#pequiven_objetive_strategic_registration_rankBottom").number(true,3,',','.');
            }
           
            //Al seleccionar alguna opción en el select de Línea Estratégica
            selectLineStrategic.on("select2-selecting", function(e) {
                chargeSelectIndicatorFromLineStrategic();
                displayObjetiveRef(e);//Actualizamos la Referencia del Objetivo a Crear
            })
            
            //Función que muestra el Número de Referencia del objetivo a crear, de acuerdo a la línea estratégica seleccionada
            function displayObjetiveRef(e){
                var data = {
                    lineStrategicId: $.trim(e.val)
                };
                $.ajax({
                    type: 'post',
                    url: '{{ path("displayRefObjetiveStrategic") }}',
                    data: data,
                    success: function(data) {
                        inputRef.val(data[0].ref);
                    }
                 });
            }
           
           //Check Para Evaluar el Objetivo a crear por Indicador
            checkIndicator.click(function() {
                if(checkIndicator.is(':checked')){
                    if(selectLineStrategic.val() === ''){
                        messageCheckIndicator.show();
                    } else{
                        buttonAddIndicator.show();
                        chargeSelectIndicatorFromLineStrategic();
                        sectionIndicators.show();
                    }
                } else{
                    buttonAddIndicator.hide();
                    sectionIndicators.hide();
                    messageCheckIndicator.hide();
                }
            });
           
            //Agarrar este select como ejemplo para los demás select2
            //Función que actualiza el select de indicadores en caso de que se cambie la lína estratégica o se agregue un nuevo indicador a partir de este formulario
            function chargeSelectIndicatorFromLineStrategic(){
                var data = {
                    lineStrategicId: $.trim(selectLineStrategic.val())
                };
                $.ajax({
                    type: 'post',
                    url: '{{ path("select_indicatorStrategicFromLineStrategic") }}',
                    data: data,
                    success: function(data) {
                        //var $indicators_selector = $("#pequiven_objetive_strategic_registration_indicators");
                        $('#pequiven_objetive_strategic_registration_indicators option[value]').remove();
                        selectIndicators.select2("val",'');
                        
                        if(typeof data[0].empty === 'undefined'){
                            for(var i=0, total = data.length; i<total; i++){
                                selectIndicators.append('<option value="' + data[i].id + '">' + data[i].description + '</option>');
                            }
                            chargeSelect2Indicators("full");
                        } else{
                            chargeSelect2Indicators("empty");
                        }
                    }
                });
            }
           
            //Función que carga el select2 de Línea Estratégica
            function chargeSelect2LineStrategic(type){
                selectLineStrategic.select2({
                    placeholder: '{{ 'form.messages.selectLineStrategicPlaceholder'|trans }}',
                    formatNoMatches: function(term) {
                        if(type == 'full'){
                            return "{{ 'form.messages.selectLineStrategicFormatNoMatcher'|trans }}";
                        } else{
                            return "{{ 'form.messages.selectLineStrategicFormatNoResult'|trans }}";
                        }
                    }
                });
            }
           
           //Función que carga el select2 de Indicadores
           function chargeSelect2Indicators(type){
                selectIndicators.select2({
                    placeholder: '{{ 'form.selectIndicatorPlaceholder'|trans ({}, 'PequivenIndicatorBundle') }}',
                    formatNoMatches: function(term) {
                        if(type == 'full'){
                            return "<a href='#lineStrategic'>{{ 'form.selectIndicatorFormatNoMatcher'|trans ({}, 'PequivenIndicatorBundle') }}</a>";
                        } else{
                            return "<a href='#lineStrategic'>{{ 'form.selectIndicatorFormatNoResult'|trans ({}, 'PequivenIndicatorBundle') }}</a>";
                        }
                    }
                });
           }
           
        });
    </script>
    
    <script>
        
        function indicatorsRegisterSuccessful(){
            $("#modals").remove();
            //document.scripts.chargeSelectIndicatorFromLineStrategic();
            document.chargeSelectIndicatorFromLineStrategic();
        }

        function openFormIndicator(){
            $.modal({
                title: '{{ 'pequiven_indicator.titleFrameAddStrategic'|trans ({}, 'PequivenIndicatorBundle') }}',
                url: '{{ path("pequiven_indicator_add_strategic_from_objetive") }}' ,
                useIframe: true,
                height: '800',
                width: '600',
                buttons: {
                        'Cerrar': {
                            classes:	'red-gradient glossy full-width',
                            click:      function(win) { win.closeModal(); }
                        }
                    }
            });
        
            /**
            $.modal.alert('Indicador',{
                    buttons: {
                        'Cerrar': {
                            classes:	'red-gradient glossy full-width',
                            click:      function(win) { win.closeModal(); }
                        }
                    }
                });
            **/
        };
        
    </script>
    {% endblock javascript %}
{% endblock body %}