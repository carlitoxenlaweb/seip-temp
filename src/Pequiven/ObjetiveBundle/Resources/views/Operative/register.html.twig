{#{% extends 'TecnocreacionesVzlaGovernmentBundle:Template:Developer/layout.html.twig' %}#}
{% extends 'PequivenSEIPBundle:Template:Developer/Common/formLayout.html.twig' %}

{% trans_default_domain 'PequivenObjetiveBundle' %}

{% import 'PequivenSEIPBundle:Template:Developer/Macros/actions.html.twig' as actions %}

{% block javascripts_base %}
    {{ parent() }}
    <!-- JavaScript at the bottom for fast page loading -->
    <!-- Scripts -->
    <script src="{{ asset('bundles/tecnocreacionesvzlagovernment/template/developer/js/libs/jquery-1.8.2.min.js') }}"></script>
    <script src="{{ asset('bundles/tecnocreacionesvzlagovernment/template/developer/js/setup.js') }}"></script>
{% endblock javascripts_base %}

{% block body %}

    <hgroup id="main-title" class="thin breadcrumb">
        <h1>
            <a href="#">{{ 'pequiven_objetive.objetives'|trans }}</a>
            <span class="icon-forward"></span>
            <span class="thin">{{ 'pequiven_objetive.add'|trans }}</span>
            <span class="icon-forward"></span>
            <span class="thin">{{ 'pequiven_objetive.operative'|trans }}</span>
        </h1>
    </hgroup>
    
    <form action="{{ path('pequiven_objetive_menu_add_operative') }}" {{ form_enctype(form) }} method="POST">
        <fieldset class="fieldset fields-list">
            <legend class="legend">{{ 'pequiven_objetive.objetives'|trans }}</legend>
            <!-- Hidden con "ComplejoName" de la persona que esta logueada -->
            <div>
                {{ form_widget(form.complejo_name) }}
            </div>
            
            <!-- Hidden con "RoleName" de la persona que esta logueada -->
            <div>
                {{ form_widget(form.role_name) }}
            </div>
                
            <!-- Línea Estratégica -->
            <div id="lineStrategic" class="field-block button-height">
                {{ form_label(form.lineStrategic) }}
                {{ form_widget(form.lineStrategic) }}
                {{ form_errors(form.lineStrategic) }}
                <span class="info-spot">
                    <span class="icon-info-round"></span>
                    <span class="info-bubble">{{ 'form.lineStrategic_info'|trans }}</span>
                </span>
            </div>
                
            <!-- Objetivo Estratégico (Padre) -->
            <div class="field-block button-height">
                {{ form_label(form.parent_strategic) }}
                {{ form_widget(form.parent_strategic) }}
                {{ form_errors(form.parent_strategic) }}
                <span class="info-spot">
                    <span class="icon-info-round"></span>
                    <span class="info-bubble">{{ 'form.parent_strategic_info'|trans }}</span>
                </span>
            </div>
                
            <!-- Objetivo Táctico (Padre) -->
            <div class="field-block button-height">
                {{ form_label(form.parent) }}
                {{ form_widget(form.parent) }}
                {{ form_errors(form.parent) }}
                <span class="info-spot">
                    <span class="icon-info-round"></span>
                    <span class="info-bubble">{{ 'form.parent_tactic_info'|trans }}</span>
                </span>
            </div>
            
            <!-- Complejo -->
            <div id="complejo" class="field-block button-height">
                {{ form_label(form.complejo) }}
                {{ form_widget(form.complejo) }}
                {{ form_errors(form.complejo) }}
                <span class="info-spot">
                    <span class="icon-info-round"></span>
                    <span class="info-bubble">{{ 'form.complejo_info'|trans }}</span>
                </span>
            </div>
            
            <!-- Gerencia -->
            <div id="gerencia" class="field-block button-height">
                {{ form_label(form.gerencia) }}
                {{ form_widget(form.gerencia) }}
                {{ form_errors(form.gerencia) }}
                <span class="info-spot">
                    <span class="icon-info-round"></span>
                    <span class="info-bubble">{{ 'form.gerencia_info'|trans }}</span>
                </span>
                {% if (role_name == 'ROLE_DIRECTIVE') or (role_name == 'ROLE_DIRECTIVE_AUX') %}
                <span id="view_check_gerencia">
                    {{ 'form.question.allGerencias'|trans }}
                    {{ form_widget(form.check_gerencia) }}
                </span>
                {% endif %}
            </div>
                
            <!-- Descripción -->
            <div class="field-block button-height">
                {{ form_label(form.description) }}
                {{ form_widget(form.description) }}
                {{ form_errors(form.description) }}
                <span class="info-spot">
                    <span class="icon-info-round"></span>
                    <span class="info-bubble">{{ 'form.description_info'|trans }}</span>
                </span>
            </div>
                
            <!-- Ref -->
            <div id="ref" class="field-block button-height">
                {{ form_label(form.ref) }}
                {{ form_widget(form.ref) }}
                {{ form_errors(form.ref) }}
                <span id="ref_info" class="info-spot">
                    <span class="icon-info-round"></span>
                    <span class="info-bubble">{{ 'form.ref_info'|trans }}</span>
                </span>
            </div>
            
            <!-- Peso del Objetivo -->
            <div id="weight" class="field-block button-height">
                {{ form_label(form.weight) }}
                {{ form_widget(form.weight) }}
                {{ form_errors(form.weight) }}
                <span class="info-spot">
                    <span class="icon-info-round"></span>
                    <span class="info-bubble">{{ 'form.weight_info'|trans }}</span>
                </span>
            </div>
                
            <!-- Meta del Objetivo -->
            <div class="field-block button-height">
                    {{ form_label(form.goal) }}
                    {{ form_widget(form.goal) }}
                    {{ form_errors(form.goal) }}
                    <span class="info-spot">
                        <span class="icon-info-round"></span>
                        <span class="info-bubble">{{ 'form.goal_info'|trans }}</span>
                    </span>
            </div>

            <!-- Rango de Gestión -->
            <fieldset class="fieldset">
                <legend class="legend">{{ 'form.rankArrangement'|trans }}</legend>

                <!-- Rango Alto del Objetivo -->
                <div class="field-block button-height">
                        {{ form_label(form.rankTop) }}
                        {{ form_widget(form.rankTop) }}
                        {{ form_errors(form.rankTop) }}
                        <span class="info-spot">
                            <span class="icon-info-round"></span>
                            <span class="info-bubble">{{ 'form.rankTop_info'|trans }}</span>
                        </span>
                </div>
                        
                <!-- Rango Medio Alto del Objetivo -->
                <div class="field-block button-height">
                        {{ form_label(form.rankMiddleTop) }}
                        {{ form_widget(form.rankMiddleTop) }}
                        {{ form_errors(form.rankMiddleTop) }}
                        <span class="info-spot">
                            <span class="icon-info-round"></span>
                            <span class="info-bubble">{{ 'form.rankMiddleTop_info'|trans }}</span>
                        </span>
                </div>
                        
                <!-- Rango Medio Bajo del Objetivo -->
                <div class="field-block button-height">
                        {{ form_label(form.rankMiddleBottom) }}
                        {{ form_widget(form.rankMiddleBottom) }}
                        {{ form_errors(form.rankMiddleBottom) }}
                        <span class="info-spot">
                            <span class="icon-info-round"></span>
                            <span class="info-bubble">{{ 'form.rankMiddleBottom_info'|trans }}</span>
                        </span>
                </div>
                        
                <!-- Rango Bajo del Objetivo -->
                <div class="field-block button-height">
                        {{ form_label(form.rankBottom) }}
                        {{ form_widget(form.rankBottom) }}
                        {{ form_errors(form.rankBottom) }}
                        <span class="info-spot">
                            <span class="icon-info-round"></span>
                            <span class="info-bubble">{{ 'form.rankBottom_info'|trans }}</span>
                        </span>
                </div>
            </fieldset>
                
            <!-- Tipo de Evaluación -->
            <fieldset class="fieldset">
                <legend class="legend">{{ 'form.typeEvaluation'|trans }}</legend>
                
                <!-- Por Indicador -->
                <div class="field-block button-height">
                    {{ form_label(form.evalIndicator) }}
                    {{ form_widget(form.evalIndicator) }}
                    {{ form_errors(form.evalIndicator) }}
                    <span class="info-spot">
                        <span class="icon-info-round"></span>
                        <span class="info-bubble">{{ 'form.evalIndicator_info'|trans }}</span>
                    </span>
                </div>
                    
                <!-- Por Programa de Gestión -->
                <div class="field-block button-height">
                    {{ form_label(form.evalArrangementProgram) }}
                    {{ form_widget(form.evalArrangementProgram) }}
                    {{ form_errors(form.evalArrangementProgram) }}
                    <span class="info-spot">
                        <span class="icon-info-round"></span>
                        <span class="info-bubble">{{ 'form.evalArrangementProgram_info'|trans }}</span>
                    </span>
                </div>
            </fieldset>
            
            {{ actions.create() }}
        </fieldset>
    {{ form_rest(form) }}
    </form>
    
    {% block javascript %}
        <script type="text/javascript">
        $(document).ready(function()
        {
           //Llamado de la función que carga los valores por defecto de la vista
           change();
           
           function change(){
               //Inicializamos el select2 de Línea Estratégica
               $("#pequiven_objetive_operative_registration_lineStrategic").select2({
                   
               });
               
               //Inicializamos el select2 de Objetivo Estratégico
               $("#pequiven_objetive_operative_registration_parent_strategic").select2({
                   
               });
               
                //Inicializamos el select2 de Objetivo Táctico
               $("#pequiven_objetive_operative_registration_parent").select2({
               });
               
               if($("#pequiven_objetive_operative_registration_complejo_name").val() === 'ZIV' && ($("#pequiven_objetive_operative_registration_role_name").val() != 'ROLE_MANAGER_SECOND' && $("#pequiven_objetive_operative_registration_role_name").val() != 'ROLE_MANAGER_SECOND_AUX')){
                    //Inicializamos el select2 de Complejo
                    $("#pequiven_objetive_operative_registration_complejo").select2({
                        
                    });
                    $("#pequiven_objetive_operative_registration_complejo").select2("enable",false);
                    
                    if($("#pequiven_objetive_operative_registration_role_name").val() === 'ROLE_DIRECTIVE' || $("#pequiven_objetive_operative_registration_role_name").val() === 'ROLE_DIRECTIVE_AUX'){
                        $("#pequiven_objetive_operative_registration_gerencia").select2({
                        
                        });
                        $("#pequiven_objetive_operative_registration_gerencia").select2("enable",false);
                        $("#view_check_gerencia").hide();
                    }
               }
               
               //Incializamos el formato numerico para el input de Peso
               $("#pequiven_objetive_operative_registration_weight").number(true,3,',','.');
               
               //Incializamos el formato numerico para el input de Meta
               $("#pequiven_objetive_operative_registration_goal").number(true,3,',','.');
               
                //Incializamos el formato numerico para el input de Rango Alto
               $("#pequiven_objetive_operative_registration_rankTop").number(true,3,',','.');
               
               //Incializamos el formato numerico para el input de Rango Medio Alto
               $("#pequiven_objetive_operative_registration_rankMiddleTop").number(true,3,',','.');
               
               //Incializamos el formato numerico para el input de Rango Medio Bajo
               $("#pequiven_objetive_operative_registration_rankMiddleBottom").number(true,3,',','.');
               
               //Incializamos el formato numerico para el input de Rango Bajo
               $("#pequiven_objetive_operative_registration_rankBottom").number(true,3,',','.');
           }
           
           $("#pequiven_objetive_operative_registration_check_gerencia").click(function() {
               checkAllGerencias();
           });
           
           //Al cambiar el select de Línea Estratégica
            $("#pequiven_objetive_operative_registration_lineStrategic").change(function() {
               var data = {
                   lineStrategicId: $.trim($(this).val()),
               };
               $.ajax({
                   type: 'post',
                   url: '{{ path("select_objetiveStrategicFromLineStrategicOperative") }}',
                   data: data,
                   success: function(data) {
                       var $objetiveStrategic_selector = $('#pequiven_objetive_operative_registration_parent_strategic');

                        $('#pequiven_objetive_operative_registration_parent_strategic option[value]').remove();
                        $objetiveStrategic_selector.append('<option value="0">Seleccione el objetivo estratégico</option>');

                        for(var i=0, total = data.length; i<total; i++){
                            $objetiveStrategic_selector.append('<option value="' + data[i].id + '">' + data[i].description + '</option>');
                        }
                        $("#pequiven_objetive_operative_registration_parent_strategic").select2("val", "");
                        $('#pequiven_objetive_operative_registration_parent option[value]').remove();
                        $("#pequiven_objetive_operative_registration_parent").append('<option value="0">Seleccione el objetivo táctico</option>');
                        $("#pequiven_objetive_operative_registration_parent").select2("val", "");
                        $("#pequiven_objetive_operative_registration_ref").val("");
                        $("#pequiven_objetive_operative_registration_complejo option[value]").remove();
                        $("#pequiven_objetive_operative_registration_complejo").select2("val","");
                        $("#pequiven_objetive_operative_registration_complejo").select2("enable",false);
                        $("#pequiven_objetive_operative_registration_gerencia optgroup").remove();
                        $("#pequiven_objetive_operative_registration_gerencia option[value]").remove();
                        $("#pequiven_objetive_operative_registration_gerencia").select2("val","");
                        $("#pequiven_objetive_operative_registration_gerencia").select2("enable",false);
                        $("#view_check_gerencia").hide();
                   }
                });
            });
            
            //Al cambiar el select de Objetivo Estratégico
            $("#pequiven_objetive_operative_registration_parent_strategic").change(function() {
               var data = {
                   objetiveStrategicId: $.trim($(this).val()),
               };
               $.ajax({
                   type: 'post',
                   url: '{{ path("select_objetiveTacticFromObjetiveStrategic") }}',
                   data: data,
                   success: function(data) {
                       var $objetiveTactic_selector = $('#pequiven_objetive_operative_registration_parent');

                        $('#pequiven_objetive_operative_registration_parent option[value]').remove();
                        $objetiveTactic_selector.append('<option value="0">Seleccione el objetivo táctico</option>');

                        for(var i=0, total = data.length; i<total; i++){
                            $objetiveTactic_selector.append('<option value="' + data[i].id + '">' + data[i].description + '</option>');
                        }
                        $("#pequiven_objetive_operative_registration_parent").select2("val", "");
                        $("#pequiven_objetive_operative_registration_ref").val("");
                        $("#pequiven_objetive_operative_registration_complejo option[value]").remove();
                        $("#pequiven_objetive_operative_registration_complejo").select2("val","");
                        $("#pequiven_objetive_operative_registration_complejo").select2("enable",false);
                        $("#pequiven_objetive_operative_registration_gerencia optgroup").remove();
                        $("#pequiven_objetive_operative_registration_gerencia option[value]").remove();
                        $("#pequiven_objetive_operative_registration_gerencia").select2("val","");
                        $("#pequiven_objetive_operative_registration_gerencia").select2("enable",false);
                        $("#view_check_gerencia").hide();
                   }
                });
            });
            
            //Al cambiar el select de Objetivo Táctico
            $("#pequiven_objetive_operative_registration_parent").change(function() {
                displayObjetiveRef();
                if($("#pequiven_objetive_operative_registration_complejo_name").val() === 'ZIV' && ($("#pequiven_objetive_operative_registration_role_name").val() != 'ROLE_MANAGER_SECOND' && $("#pequiven_objetive_operative_registration_role_name").val() != 'ROLE_MANAGER_SECOND_AUX')){
                    displaySelectComplejoFromObjetiveTactic();
                    //$("#pequiven_objetive_operative_registration_complejo").show();
                }
            });
            
            //Al cambiar el select de Complejo
            $("#pequiven_objetive_operative_registration_complejo").change(function() {
                if($("#pequiven_objetive_operative_registration_role_name").val() === 'ROLE_DIRECTIVE' || $("#pequiven_objetive_operative_registration_role_name").val() === 'ROLE_DIRECTIVE_AUX'){
                    displaySelectGerenciaFromComplejo();
                }
            });
            
            //Función que actualiza el select de complejos en caso de que el usuario logueado sea de Sede Corporativa
            function displaySelectComplejoFromObjetiveTactic(){
                var data = {
                    objetiveTacticId: $.trim($("#pequiven_objetive_operative_registration_parent").val()),
                };
                $.ajax({
                    type: 'post',
                    url: '{{ path("select_complejoFromObjetiveTactic") }}',
                    data: data,
                    success: function(data) {
                        var $complejo_selector = $("#pequiven_objetive_operative_registration_complejo");
                        
                        $("#pequiven_objetive_operative_registration_complejo option[value]").remove();
                        var complejos = [];
                        //Actualizamos el select de complejos
                        for(var i=0, total = data.length; i<total; i++){
                            $complejo_selector.append('<option value="' + data[i].id + '" selected="selected">' + data[i].description + '</option>');
                            complejos[i] = data[i].id;
                        }
                        
                        if($("#pequiven_objetive_operative_registration_role_name").val() === 'ROLE_DIRECTIVE' || $("#pequiven_objetive_operative_registration_role_name").val() === 'ROLE_DIRECTIVE_AUX'){
                            displaySelectGerenciaFromComplejo(complejos);
                            displaySelectObjetiveStrategicFromObjetiveTactic();
                        } else if($("#pequiven_objetive_operative_registration_role_name").val() === 'ROLE_MANAGER_FIRST' || $("#pequiven_objetive_operative_registration_role_name").val() === 'ROLE_MANAGER_FIRST_AUX'){
                            displaySelectObjetiveStrategicFromObjetiveTactic();
                        }
                       // $("#pequiven_objetive_operative_registration_complejo").select2("val",array(1,6));
                       $("#pequiven_objetive_operative_registration_complejo").select2({
                        });
                        $("#pequiven_objetive_operative_registration_complejo").select2("enable",true);
                        $("#view_check_gerencia").show();
                    }
                });
            }
            
            //Función que actualiza el select de objetivos estratégicos de acuerdo al objetivo táctico seleccionado
            function displaySelectObjetiveStrategicFromObjetiveTactic(){
                var data = {
                    objetiveTacticId: $.trim($("#pequiven_objetive_operative_registration_parent").val()),
                    lineStrategicId: $.trim($("#pequiven_objetive_operative_registration_lineStrategic").val()),
                };
                $.ajax({
                    type: 'post',
                    url: '{{ path("select_objetiveStrategicFromObjetiveTactic") }}',
                    data: data,
                    success: function(data) {
                        var $objetiveStrategic_selector = $("#pequiven_objetive_operative_registration_parent_strategic");
                        
                        $("#pequiven_objetive_operative_registration_parent_strategic option[value]").remove();
                        $("#pequiven_objetive_operative_registration_parent_strategic").select2("val",'');
                        //Actualizamos el select de objetivo estratégico
                        for(var i=0, total = data.length; i<total; i++){
                            if(data[i].selected == 'YES'){
                                $objetiveStrategic_selector.append('<option value="' + data[i].id + '" selected="selected">' + data[i].description + '</option>');
                            } else{
                                $objetiveStrategic_selector.append('<option value="' + data[i].id + '">' + data[i].description + '</option>');
                            }
                        }
                        $("#pequiven_objetive_operative_registration_parent_strategic").select2({
                        });
                        for(var i=0, total = data.length; i<total; i++){
                            if(data[i].selected == 'YES'){
                                $("#pequiven_objetive_operative_registration_parent_strategic").select2("val",data[i].id);
                            }
                        }
                    }
                });
            }
            
            //Función que actualiza el select de gerencia en caso de que el usuario logueado sea de Sede Corporativa
            function displaySelectGerenciaFromComplejo(complejos){
            var data = '';
                if(complejos instanceof Array){//En caso de que la data provenga al momento de cambiar el select de Objetivo Táctico
                    var dataComplejo = '';
                    var totalComplejos = complejos.length;
                    for(var i=0, total = complejos.length; i<total; i++){
                        if(i == (totalComplejos - 1)){
                            dataComplejo = dataComplejo + complejos[i];
                        } else{
                            dataComplejo = dataComplejo + complejos[i] + ',';
                        }
                    }
                    data = {
                        complejos: dataComplejo,
                    };
                } else{
                    data = {
                        complejos: $.trim($("#pequiven_objetive_operative_registration_complejo").val()),
                    };
                }
                $.ajax({
                    type: 'post',
                    url: '{{ path("select_gerenciaFromComplejoOperative") }}',
                    data: data,
                    success: function(data) {
                        var $gerencia_selector = $("#pequiven_objetive_operative_registration_gerencia");

                        $("#pequiven_objetive_operative_registration_gerencia optgroup").remove();
                        $("#pequiven_objetive_operative_registration_gerencia option[value]").remove();

                        //Actualizamos el select de gerencias
                        var cantidad = data.length;
                        var text = '';
                        text = text + '<optgroup label="' + data[0].optGroup + '">';
                        //$gerencia_selector.append('<optgroup label="' + data[0].optGroup + '">');
                         for(var i=0, total = data.length; i<total; i++){
                             if(i == 0){
                                 text = text + '<option value="' + data[i].id + '" >' + data[i].description + '</option>';
                                 //$gerencia_selector.append('<option value="' + data[i].id + '" >' + data[i].description + '</option>');
                             } else if (data[i].idComplejo != data[i-1].idComplejo && (i + 1) < cantidad ){
                                 text = text + '</optgroup> <optgroup label="' + data[i].optGroup + '">';
                                 //$gerencia_selector.append('</optgroup> <optgroup label="' + data[i].optGroup + '">');
                             } else if ((i+1) == cantidad){
                                 text = text +'<option value="' + data[i].id + '" >' + data[i].description + '</option> </optgroup>';
                                 //$gerencia_selector.append('<option value="' + data[i].id + '" >' + data[i].description + '</option> </optgroup>');
                             } else{
                                 text = text + '<option value="' + data[i].id + '" >' + data[i].description + '</option>';
                                 //$gerencia_selector.append('<option value="' + data[i].id + '" >' + data[i].description + '</option>');
                             }
                         }
                         $gerencia_selector.append(text);
                         $("#pequiven_objetive_operative_registration_gerencia").select2({
                         });
                         $("#pequiven_objetive_operative_registration_gerencia").select2("enable",true);
                         $("#view_check_gerencia").show();
                    }
                 });
            }
                        
            //Función que muestra el Número de Referencia del objetivo a crear, de acuerdo al táctico seleccionado
            function displayObjetiveRef(){
                var data = {
                    objetiveTacticId: $.trim($("#pequiven_objetive_operative_registration_parent").val())
                };
                $.ajax({
                    type: 'post',
                    url: '{{ path("displayRefObjetiveOperative") }}',
                    data: data,
                    success: function(data) {
                        $("#pequiven_objetive_operative_registration_ref").val(data[0].ref);
                    }
                 });
            }
            
            //Función que "marca" todas las gerencias de los complejos seleccionados
            function checkAllGerencias(){
                if($("#pequiven_objetive_operative_registration_check_gerencia").is(':checked')){
                    $('#pequiven_objetive_operative_registration_gerencia').select2("val",'');
                    $('#pequiven_objetive_operative_registration_gerencia').select2("enable",false);
                } else{
                    $('#pequiven_objetive_operative_registration_gerencia').select2("enable",true);
                }
            }
            
        });
    </script>
    {% endblock javascript %}
{% endblock body %}